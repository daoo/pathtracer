#!/usr/bin/env bash

set -eu

out="$(realpath out)"
src="$(realpath src)"
build="$(realpath build)"

function configure() {
  path="${out}_${1}"
  echo "${path}/build.ninja"
  mkdir -p "${path}"
  cat - "${build}/build.ninja.template" <<DOC > "${path}/build.ninja"
src = ${src}
outdir = ${path}
cxx = ${2}
cxxflags = ${3}
ldflags = ${4}
DOC
}

configure "clang_debug" \
  "clang++" \
  "-Weverything -Wno-missing-prototypes -Wno-c++98-compat -Wno-padded -Wno-weak-vtables -g -Xclang -fcolor-diagnostics" \
  ""

configure "clang_release" \
  "clang++" \
  "-Ofast -march=native -DNDEBUG" \
  ""

configure "clang_sanitize" \
  "clang++" \
  "-Wall -g -fsanitize=address,undefined" \
  "-fsanitize=address,undefined"

configure "gcc_debug" \
  "g++" \
  "-Wall -Wextra -Weffc++ -Wno-padded -g -fdiagnostics-color=always" \
  ""

configure "gcc_release" \
  "g++" \
  "-Ofast -march=native -flto -DNDEBUG" \
  "-flto"

configure "iwyu" \
  "include-what-you-use -Xiwyu --mapping_file=${build}/glm.imp" \
  "" \
  ""
